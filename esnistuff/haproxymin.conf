# Basic config mapping a listening IP:port to another host's IP:port with
# support for HTTP/1 and 2.

global
   strict-limits  # refuse to start if insufficient FDs/memory
   # add some process-wide tuning here if required

   # A stats socket may be added to check live metrics if the load generators
   # do not report them.
   #    stats socket /tmp/haproxy.sock level admin
   #    stats timeout 1h

   # haproxy doesn't log to files - worry about that later
   #log ./haproxy/logs/hap.log local0
   #log ./haproxy/logs/hap.log local1 notice

defaults
   # log global
   mode http
   balance random      # power-of-two-choices
   timeout client 60s
   timeout server 60s
   timeout connect 1s

frontend ECH-front
    bind :7443 ech echconfig.pem ssl crt cadir/foo.example.com.pem
    use_backend 3480
backend 3480
    # set a cookie so we know haproxy was there
    cookie SERVERUSED insert indirect nocache
    server s1 127.0.3.4:3480

frontend Two-TLS
    bind :7444 ech echconfig.pem ssl crt cadir/foo.example.com.pem
    use_backend 3481
backend 3481
    # set a cookie so we know haproxy was there
    cookie SERVERUSED insert indirect nocache
    server s1 127.0.3.4:3481 ssl ca-file cadir/oe.csr 

frontend One-TLS
    mode tcp
    bind :7445
    use_backend 3482
backend 3482
    mode tcp
    option ssl-hello-chk
    server example.com 127.0.3.4:3482 check
